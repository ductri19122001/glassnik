generator client {
  provider        = "prisma-client-js"
}

datasource db {
  provider = "postgresql"

}

model User {
  id                      Int                       @id @default(autoincrement())
  email                   String                    @unique @db.VarChar(255)
  username                String?                   @unique @db.VarChar(100)
  displayName             String?                   @map("display_name") @db.VarChar(150)
  avatarUrl               String?                   @map("avatar_varcharurl")
  passwordHash            String?                   @map("password_hash") @db.VarChar(255)
  emailVerified           Boolean?                  @default(false) @map("email_verified")
  provider                String?                   @default("local") @map("provider") @db.VarChar(50)
  providerId              String?                   @map("provider_id") @db.VarChar(255)
  lastLoginAt             DateTime?                 @map("last_login_at") @db.Timestamp(6)
  status                  String?                   @default("ACTIVE") @db.VarChar(50)
  createdAt               DateTime?                 @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt               DateTime?                 @default(now()) @map("updated_at") @db.Timestamp(6)
  capabilityApplications  CapabilityApplication[]
  refreshTokens           RefreshToken[]
  subscriptions           Subscription[]
  userCapabilities        UserCapability[]
  videoAssets             VideoAsset[]

  @@map("users")
}

model RefreshToken {
  id         Int       @id @default(autoincrement())
  userId     Int       @map("user_id")
  tokenHash  String    @map("token_hash") @db.VarChar(255)
  isRevoked  Boolean?  @default(false) @map("is_revoked")
  expiresAt  DateTime  @map("expires_at") @db.Timestamp(6)
  createdAt  DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_refresh_token_user")

  @@map("refresh_tokens")
  @@index([userId], map: "idx_refresh_tokens_user_id")
}

model Capability {
  id                Int                   @id @default(autoincrement())
  name              String                @unique @db.VarChar(100)
  iconUrl           String?               @map("icon_url")
  badgeType         CapabilityBadgeType   @map("badge_type")
  minAmount         Decimal?              @map("min_amount") @db.Decimal(10, 2)
  minMonths         Int?                  @map("min_months")
  isActive          Boolean?              @default(true) @map("is_active")
  createdAt         DateTime?             @default(now()) @map("created_at") @db.Timestamp(6)
  userCapabilities  UserCapability[]

  @@map("capabilities")
}

model UserCapability {
  id                 Int           @id @default(autoincrement())
  userId             Int           @map("user_id")
  capabilityId       Int           @map("capability_id")
  status             CommonStatus
  grantedDatetimeby  DateTime?     @map("granted_datetimeby") @db.Timestamp(6)
  grantedAt          DateTime?     @default(now()) @map("granted_at") @db.Timestamp(6)
  expiresAt          DateTime?     @map("expires_at") @db.Timestamp(6)
  capability         Capability    @relation(fields: [capabilityId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_user_cap_capability")
  user               User          @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_user_cap_user")

  @@map("user_capabilities")
  @@unique([userId, capabilityId], map: "uq_user_capability")
  @@index([capabilityId], map: "idx_user_capabilities_capability_id")
  @@index([userId], map: "idx_user_capabilities_user_id")
}

model CapabilityApplication {
  id              Int           @id @default(autoincrement())
  userId          Int           @map("user_id")
  capabilityCode  String        @map("capability_code") @db.VarChar(100)
  status          CommonStatus  @default(PENDING)
  reviewerId      Int?          @map("reviewer_id")
  notes           String?
  createdAt       DateTime?     @default(now()) @map("created_at") @db.Timestamp(6)
  reviewedAt      DateTime?     @map("reviewed_at") @db.Timestamp(6)
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_cap_app_user")

  @@map("capability_applications")
  @@index([userId], map: "idx_capability_applications_user_id")
}

model Subscription {
  id                        Int       @id @default(autoincrement())
  userId                    Int       @map("user_id")
  planCode                  String    @map("plan_code") @db.VarChar(100)
  status                    String    @db.VarChar(50)
  startedAt                 DateTime? @map("started_at") @db.Timestamp(6)
  endedAt                   DateTime? @map("ended_at") @db.Timestamp(6)
  processorSubscriptionId   String?   @map("processor_subscription_id") @db.VarChar(255)
  processorCustomerId       String?   @map("processor_customer_id") @db.VarChar(255)
  currentPeriodEnd          DateTime? @map("current_period_end") @db.Timestamp(6)
  user                      User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_subscription_user")

  @@map("subscriptions")
  @@index([userId], map: "idx_subscriptions_user_id")
}

model VideoAsset {
  id                  Int       @id @default(autoincrement())
  ownerId             Int       @map("owner_id")
  title               String?   @db.VarChar(255)
  description         String?
  source              String?   @db.VarChar(50)
  gcsPath             String?   @map("gcs_path") @db.VarChar(500)
  publicUrl           String?   @map("public_url")
  mimeType            String?   @map("mime_type") @db.VarChar(50)
  sizeBytes           BigInt?   @map("size_bytes")
  durationSeconds     Int?      @map("duration_seconds")
  metadata            Json?
  eligibleForStitch   Boolean?  @default(false) @map("eligible_for_stitch")
  status              String?   @db.VarChar(50)
  createdAt           DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  owner               User      @relation(fields: [ownerId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_video_owner")

  @@map("video_assets")
  @@index([ownerId], map: "idx_video_assets_owner")
}

enum CapabilityBadgeType {
  SYSTEM
  SUBSCRIPTION
  APPLICATION

  @@map("capability_badge_type")
}

enum CommonStatus {
  PENDING
  ACTIVE
  APPROVED
  REJECTED
  REVOKED
  EXPIRED

  @@map("common_status")
}
